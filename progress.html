<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <title>Stump Up For Trees</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <!-- https://github.com/torfsen/leaflet.zoomhome -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="leaflet.zoomhome.css"/>
    <script src="leaflet.zoomhome.min.js"></script>

    <!-- Tree Scale -->
    <link rel="stylesheet" href="leaflet.treescale.css"/>
    <script src="leaflet.treescale.js"></script>

    <style>
      #mapid {
        width: 800px;
        height: 600px;
      }
      .info {
          padding: 6px 8px;
          font: 14px/16px Arial, Helvetica, sans-serif;
          background: white;
          background: rgba(255,255,255,0.8);
          box-shadow: 0 0 15px rgba(0,0,0,0.2);
          border-radius: 5px;
      }
      .info h4 {
          margin: 0 0 5px;
          color: #777;
      }
    </style>
  </head>

  <body>
    <div id="mapid"></div>

    <script>
      // Area functions
      const TREES_PER_HECTARE = 175000 / 75; // based on planting 175000 trees on 75 ha of Bryn Awr
      const AREA_FOR_1M_TREES_IN_HA = 1000000 / TREES_PER_HECTARE;

      function acresToSqKm(acres) {
        return acres / 247;
      }

      function hectaresToSqKm(ha) {
        return ha / 100;
      }

      function hectaresToSqM(ha) {
        return 1000 * 1000 * ha / 100;
      }

      function hectaresToAcres(ha) {
        return ha * 2.471;
      }

      // These bounds were found by inspecting bbnpLayer.getBounds() from below, or by choosing one by eye
      const bbnpBounds = [[51.702084424752776, -3.9895865479772916], [52.078310203734624, -2.9520696481307245]];
      const extentBounds = [[51.85195384722623, -3.127506680893053], [51.8875385405915, -3.006924188253357]];
      const bounds = [[51.80606740275158, -3.204574584960938], [51.93325857832681, -2.9299163818359375]];

      // Create a map
      const map = L.map("mapid", {zoomControl: false}).fitBounds(bounds);

      // Add a home button to reset map
      var zoomHome = L.Control.zoomHome();
      zoomHome.addTo(map);

      // Use Open Street Map tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Show Brecon Beacons National Park boundary

      // var bbnpLayer = new L.GeoJSON.AJAX("data/brecon_beacons_national_park_boundary_simplified.json", {
      //     style: {
      //       color: '#3388ff',
      //       opacity: '0.5',
      //       fillOpacity: 0.1,
      //       fillColor: '#3388ff'
      //     }
      //   })
      //   .on("data:loaded", function() {
      //     //map.fitBounds(bbnpLayer.getBounds());
      //   })
      //   .addTo(map);

      // Show planting areas

      const plantingAreaStyle = {
            color: 'green',
            opacity: 0.9,
            fillOpacity: 0.4
      };

      const plantingLayer = new L.GeoJSON.AJAX("data/planting_areas.geojson", {style: plantingAreaStyle})
        .on("data:loaded", function(data) {
          let totalHa = 0;
          for (let key in plantingLayer._layers){
            totalHa += plantingLayer._layers[key].feature.properties.area_ha;
          }
          const pct = 100 * totalHa / AREA_FOR_1M_TREES_IN_HA;
          new TreeScale({
            position: 'bottomleft',
            treesPerHectare: TREES_PER_HECTARE,
            progress: pct
          }).addTo(map);
        })
        .bindPopup(layer => {
          const props = layer.feature.properties;
          const area_ac = hectaresToAcres(props.area_ha);
          const num_trees = Math.round(TREES_PER_HECTARE * props.area_ha / 1000) * 1000; // round to nearest 1000
          const pct = 100 * props.area_ha / AREA_FOR_1M_TREES_IN_HA;
          const notes = props.notes == null ? '' : props.notes;
          return `<b>${props.name}</b>: ${props.area_ha.toFixed(0)} ha, ${area_ac.toFixed(0)} ac, ${num_trees} trees, ${pct.toFixed(1)}%<br/>${notes}`;
        })
        .addTo(map);

      // Add an info control
      var info = L.control({position: 'topright'});

      info.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'info');
          this.update();
          return this._div;
      };

      info.update = function (props) {
          this._div.innerHTML = '<h4>Stump Up For Trees</h4> Click on a planting area';
      };

      info.addTo(map);

      // Uncomment to get lat long for point clicked on map
      // map.on('click', function(ev){
      //   var latlng = map.mouseEventToLatLng(ev.originalEvent);
      //   console.log(latlng.lat + ', ' + latlng.lng);
      //   console.log(map.getBounds());
      // });
    </script>
  </body>
</html>
